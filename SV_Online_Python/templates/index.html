{% load staticfiles %}
<!DOCTYPE html>
<!--
AUTHOR: CONG WANG
DATE: 25/02/2016
-->
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
    <title>Ceagle Online</title>
    <link rel="shortcut icon" href="{% static "images/favicon.ico" %}"/>
    <link rel="stylesheet" type="text/css" href="{% static "css/envelope.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "css/libnotify.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "css/zTreeStyle.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "css/bootstrap.min.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "css/uploadfile.css" %}">
  </head>
  <body>
    <img id="ins1" class="instruction" src="{% static "images/1.png" %}"/>
    <img id="ins2" class="instruction" src="{% static "images/2.png" %}"/>
    <img id="ins3" class="instruction" src="{% static "images/3.png" %}"/>
    <img id="ins4" class="instruction" src="{% static "images/4.png" %}"/>
    <div id="welcome">
      <div id="welcome-bk"></div>
      <img id="welcome-logo" src="{% static "images/ceagle.png" %}"/>`
    </div>
    <div id="toolbar">
      <div id="toolbar-content">
        <img id="upload-btn" title="UPLOAD" data-toggle='modal' data-target='#myModal7' src="{% static "images/upload.png" %}"/>
        <img id="folder-btn" title="NEW FOLDER" data-toggle='modal' data-target='#myModal4' src="{% static "images/folder.png" %}"/>
        <img id="file-btn" title="NEW FILE" data-toggle='modal' data-target='#myModal5' src="{% static "images/file.png" %}"/>
        <img id="logout-btn" title="LOG OUT" src="{% static "images/logout.png" %}"/>
        <img id="recommend-btn" title="ASSERION RECOMMEND" src="{% static "images/recommend.png" %}"/>
        <div style="float:right;width:200px;line-height:15px;">Safety Critical Assertion Recommendation</div>
      </div>
    </div>
    <div id="skyline"></div>
    <div id="line"></div>
    <div id="line2"></div>
    <div id="line3"></div>
    <div id="tree" class="ztree"></div>
    <div id="console">
      <p id="as" style="text-align:center;border-bottom:1px black solid"><b>Attribute Selection</b></p>
      <div id="result-as" style="text-align:center; height:23.5%; width:100%;overflow-x: auto; overflow-y:auto;margin-bottom:3px">
        <center id="default-as">
          <p>You should choose a file from the left panel.</p>
        </center>
        <table id="mytable" class="mytable" style='display:none;margin:0px auto;border:1px solid grey;margin-top: 10px;' border="1">
          <tr>
            <th>No.</th>
            <th>Line</th>
            <th>Attribute</th>
            <th>Verify</th>
          </tr>
        </table>
        <div id="caption-as" style='display:none'>
          <br>
          <p>* Click the VERIFY button to verify the assertion.</p>
        </div>
      </div>
      <p id="ar" style="text-align:center;border-bottom:1px black solid;border-top:1px black solid"><b>Safety Critical Assertion Recommendation</b></p>
      <div id="result-ar" style="text-align:center; height:23.5%; width:100%;overflow-x: auto; overflow-y:auto;margin-bottom:3px">
        <center id="default-ar">
          <p>You should choose a file from the left panel.</br>
          Then click "Assertion Recommend" button.</p>
        </center>
        <table id="mytable2" class="mytable" style='display:none;margin:0px auto;border:1px solid grey;margin-top: 10px;' border="1">
          <tr>
            <th>Assertion</th>
            <th>Expression</th>
            <th>Choice</th>
          </tr>
        </table>
        <div id="caption-ar" style='display:none'>
          <br>
          <p>* We have never recommend assertions for this file.</br>
            Click "Assertion Recommend" button.</p>
        </div>
        <div id="caption-ar2" style='display:none'>
          <br>
          <p>* Choose ACCEPT or REJECT to feedback.</p>
        </div>
      </div>
      <p id="ct" style="text-align:center;border-bottom:1px black solid;border-top:1px black solid"><b>Counter Trace</b></p>
      <div class="msg-text" style="margin: 0 10px; height:40%">
        <div id="tree2" class="ztree"></div>
      </div>
    </div>
    <div id="Log">
      <p style="text-align:center;border-bottom:1px black solid; margin-bottom:1px" id="log_title"><b>Terminator</b></p>
      <div id="log_content">
      </div>
    </div>
    <div id="editor"></div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel">
              Please input the new name:
            </h4>
          </div>
          <div class="modal-body">
            <p>New Name: <input id="new_name"></input></p>
            <div class="modal-footer">
              <button type="button" class="btn btn-default"
              data-dismiss="modal">Close
              </button>
              <button id="save_name" type="button" class="btn btn-primary">
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel">
              Delete The File:
            </h4>
            <p id="delete_file_name" style="text-align: center"></p>
          </div>
          <div class="modal-body">
            <div class="modal-footer">
              <button type="button" class="btn btn-default"
              data-dismiss="modal">N O
              </button>
              <button id="delete_file" type="button" class="btn btn-primary">
                YES
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel">
              Please input the new name:
            </h4>
          </div>
          <div class="modal-body">
            <p>New Name: <input id="rename_folder_name"></input></p>
            <div class="modal-footer">
              <button type="button" class="btn btn-default"
              data-dismiss="modal">Close
              </button>
              <button id="save_folder_name" type="button" class="btn btn-primary">
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModal4" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel">
              Create New Folder:
            </h4>
          </div>
          <div class="modal-body">
            <p>New Name: <input id="new_folder_name"></input></p>
            <div class="modal-footer">
              <button type="button" class="btn btn-default"
              data-dismiss="modal">Close
              </button>
              <button id="create_folder" type="button" class="btn btn-primary">
                Create
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModal5" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel">
              Create New File(*.c):
            </h4>
          </div>
          <div class="modal-body">
            <p>New Name: <input id="new_file_name"></input></p>
            <div class="modal-footer">
              <button type="button" class="btn btn-default"
              data-dismiss="modal">Close
              </button>
              <button id="create_file" type="button" class="btn btn-primary">
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModal6" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel">
              Delete The Folder:
            </h4>
            <p id="delete_folder_name" style="text-align: center"></p>
          </div>
          <div class="modal-body">
            <div class="modal-footer">
              <button type="button" class="btn btn-default"
              data-dismiss="modal">N O
              </button>
              <button id="delete_folder" type="button" class="btn btn-primary">
                YES
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="myModal7" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <form id="upload" action="" method="post" enctype="multipart/form-data" style="text-align: center;">
              {% csrf_token %}
              <p>{{ form.non_field_errors }}</p>

              <p>{{ form.docfile.label_tag }} {{ form.docfile.help_text }}</p>

              <p>
                  {{ form.docfile.errors }}
                  {{ form.docfile }}
              </p>
              <button type="submit" class="btn">Upload!</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="acceptModal" tabindex="-1" role="dialog" aria-labelledby="acceptModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="acceptModalLabel">Make Sure</h4>
                </div>
                <div class="modal-body">Make Sure That You Accept This Recommendation</div>
                <div class="modal-footer">
                    <button type="button" id="btnAccept" class="btn btn-primary" data-dismiss="modal">YES</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">NO</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="rejectModalLabel">Make Sure</h4>
                </div>
                <div class="modal-body">Make Sure That You Reject This Recommendation</div>
                <div class="modal-footer">
                    <button type="button" id="btnReject" class="btn btn-primary" data-dismiss="modal">YES</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">NO</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>


    <script src="{% static "src-min-noconflict/ace.js" %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static "js/jquery-1.12.1.min.js" %}" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="{% static "js/envelope.jquery.js" %}"></script>
    <script type="text/javascript" src="{% static "js/humane.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery.ztree.core.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/bootstrap.min.js" %}"></script>
    <script src="{% static "js/jquery.uploadfile.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/jquery.cookie.js" %}" type="text/javascript"></script>
    <script src="{% static "js/main.js" %}" type="text/javascript"></script>
    <script>
      function zTreeOnClick(event, treeId, treeNode) {
        $("#default-ar").css("display", "none");
        $("#default-as").css("display", "none");
        $("#mytable2").css("display", "none");
        $("#mytable").fadeIn();
        $("#caption-as").fadeIn();
        $("#caption-ar").fadeIn();
        if (current_file.length != 0 && current_change == 1){
          save_current();
        }
        if(treeNode.level == 0 || treeNode.isParent){
          return;
        }
        current_file = get_filename(treeNode);
        add_log("Open: " + current_file);
        var perHeight = $($("#log_content").children()[0]).height();
        $("#log_content").scrollTop(perHeight * $("#log_content").children().length);
        <!--Get The Code-->
        $.ajax({
          type: "GET",
          url: "/filecontent/",
          data: {"filename": current_file},
          dataType: "json",
          success: function(data){
            current_code = data['data']
            editor.setValue(current_code);
            editor.navigateTo(0, 0);
            code_array = current_code.split('\n');
            assert_array = [];
            var j = 1;
            $("#mytable tbody tr").remove("tr.as-item");
            for(var i = 0; i < code_array.length; i++){
              if((code_array[i].trim().indexOf("__VERIFIER_assert") == 0) || (code_array[i].trim().indexOf("__VERIFIER_error") == 0)){
                $("#mytable").append("<tr class=\"as-item\" data-row=\""+i+"\" data-column=\"0\"><td>"+j+"</td><td>"+(i + 1)+"</td><td>"+code_array[i].trim()+"</td><td onclick=\"verify_button()\"><img style='width:18px' src=" + "{% static "images/verify.png" %}" + "></td></tr>");
               j++;
              }
            }
            $(".as-item").click(function(){
              var row = $(this).attr("data-row");
              var column = $(this).attr("data-column");
              editor.navigateTo(row, column);
            });
            current_change = 0;
          }
        });
        <!--Get The Previos Assertion-->
        $.ajax({
          type: "GET",
          url: "/assertionrecommend/",
          data: {"filename": current_file},
          dataType: "json",
          success: function(data){
            if(JSON.stringify(data)!="{}"){
              $("#caption-ar").css("display", "none");
              $("#caption-ar2").fadeIn();
              $("#mytable2 tbody tr").remove("tr.as-item");
              $("#mytable2").append("<tr class=\"as-item\" data-row=\"1\" data-column=\"0\"><td>" + data["need"] + "</td><td>" + data["expr"] + "</td><td>" + data["accept"] + "</td></tr>");
              $('#mytable2').fadeIn();
            }
            else{
              $("#caption-ar2").css("display", "none");
              $("#caption-ar").fadeIn();
            }

          }
        });
      };
      function zTreeOnRightClick(event, treeId, treeNode) {
        if(curr_right_click != ""){
          $("#right_menu").remove();
          curr_right_click = "";
        }
        if(treeNode.level == 0){
          return;
        }
        if(treeNode.isParent){
          curr_right_click = get_filename(treeNode);
          $("body").append("<div id='right_menu' style='top:"+event.pageY+"px;left:"+event.pageX+"px'><div><button data-toggle='modal' data-target='#myModal3'>Rename</button></div><div><button data-toggle='modal' data-target='#myModal4'>New Folder</button></div><div><button data-toggle='modal' data-target='#myModal5'>New File</button></div><div><button data-toggle='modal' data-target='#myModal6'>Delete</button></div><div><button onclick='download_folder()'>Download</button></div></div>");
          $("#rename_folder_name").val(treeNode.name);
          $("#delete_folder_name").html(treeNode.name);
          $('#new_folder_name').val("");
          $('#new_file_name').val("");
        }
        else{
          curr_right_click = get_filename(treeNode);
          $("body").append("<div id='right_menu' style='top:"+event.pageY+"px;left:"+event.pageX+"px'><div><button data-toggle='modal' data-target='#myModal'>Rename</button></div><div><button data-toggle='modal' data-target='#myModal2'>Delete</button></div><div><button onclick='download_file()'>Download</button></div></div>");
          $("#new_name").val(treeNode.name);
          $("#delete_file_name").html(treeNode.name);
        }
      };
      var zTreeOnClick2 = function(event, treeId, treeNode){
        trace_line = treeNode.line_num;
        editor.navigateTo(trace_line - 1, 0);
      }
      var setting = {
        view: {
          selectedMulti: false,
        },
        data: {
          simpleData: {
            enable: true
          }
        },
        callback: {
          onClick: zTreeOnClick,
          onRightClick: zTreeOnRightClick
        }
      };
      var setting2 = {
        view: {
          selectedMulti: false,
          showIcon: false,
          autoCancelSelected: false
        },
        data: {
          simpleData: {
            enable: true
          }
        },
        callback: {
          onClick: zTreeOnClick2,
        }
      };
      var add_log = function(cont){
        $("#log_content").append("<p>--" + cont + "</p>");
      };
      var current_file = "";
      var current_change = 0;
      editor.getSession().on('change', function(e){
        if(current_change == 0){
          current_change = 1;
        }
      });
      $(document).ready(function(){
        var code_array = [];
        $.fn.zTree.init($("#tree"), setting, {{zNodes|safe}});
        $("#line").mousedown(function(e){
          $(document).mousemove(function(e){
            $("#tree").css("width", (e || event).clientX + "px");
            $("#editor").css("left", (e || event).clientX + "px");
            $("#line").css("left", (e || event).clientX + "px");
            $("#tab-list").css("left", (e || event).clientX + "px");
            $("#Log").css("left", (e || event).clientX + "px");
            $("#line3").css("left", (e || event).clientX + "px");
          });
          $(document).mouseup(function(){
            $(document).unbind("mousemove");
          });
        });
        $("#line2").mousedown(function(e){
          $(document).mousemove(function(e){
            $("#console").css("width", $(document).width() - (e || event).clientX + "px");
            $("#editor").css("right", $(document).width() - (e || event).clientX + "px");
            $("#line2").css("left", (e || event).clientX + "px");
            var mLeft = $("#tree").width();
            $("#tab-list").css("width", (e || event).clientX - mLeft + "px");
            $("#Log").css("width", (e || event).clientX - mLeft + "px");
            $("#line3").css("width", (e || event).clientX - mLeft + "px");
          });
          $(document).mouseup(function(){
            $(document).unbind("mousemove");
          });
        });
        $("#line3").mousedown(function(e){
          var max_height = $(document).height() * 0.9;
          $(document).mousemove(function(e){
            if((e || event).clientY < max_height){
              $("#editor").css("bottom", $(document).height() - (e || event).clientY + "px");
              $("#line3").css("top", (e || event).clientY + "px");
              $("#Log").css("top", (e || event).clientY + "px");
              $("#Log").css("bottom", "0px");
            }
          });
          $(document).mouseup(function(){
            $(document).unbind("mousemove");
          });
        });
        window.setTimeout(function(){
          $("#welcome").fadeOut(500);
        }, 250);
        $(".as-item").click(function(){
          var row = $(this).attr("data-row");
          var column = $(this).attr("data-column");
          editor.navigateTo(row, column);
        });
        // $("#upload-btn").click(function(){
        //   $("#choose-file").css("display", "block");
        //   $("#welcome").fadeIn(1000);
        // });
        $("#logout-btn").click(function(){
          $.cookie('user_name', null, {path: '/', expires:1});
          $.cookie('user_pass', null, {path: '/', expires:1});
          location.href = "../login/"
        });
        $("#welcome-bk").click(function(){
          $("#welcome").fadeOut(1000);
        });
        humane.error = humane.spawn({ addnCls: 'humane-libnotify-error', timeout: 1500 });
        $("#log_content").css("top", $("#log_title").css("height"));
        if($.cookie('first_time')!="NO"){
          $("#ins1").css("display", "block");
          $.cookie('first_time', 'NO', {expires: 3650});
        };

        <!--Assertion Recommendation-->
        var assertion_recommendation = function() {
          $.ajax({
            type: "GET",
            url: "/api/assertion_recommendation/",
            data: {
              'filename': current_file
            },
            dataType: "json",
            success: function(data) {
              var function_array = data;
              $("#mytable2 tbody tr").remove("tr.as-item");
              for (var i = 0; i < function_array.length; i++) {
                $("#mytable2").append("<tr class=\"as-item\" data-row=\"" + i + "\" data-column=\"0\"><td>" + function_array[i]["needAssertion"] + "</td><td>" + function_array[i]["expr"] + "</td><td><a onclick='arClick(this)' data-name=" + function_array[i]["common_index_array"] + " data-toggle='modal' data-target='#acceptModal'>ACCEPT</a> / <a onclick='arClick(this)' data-name=" + function_array[i]["common_index_array"] + " data-toggle='modal' data-target='#rejectModal' style='color:red'>REJECT</a></td></tr>");
              }
              $('#mytable2').fadeIn();
            }
          });
        };
        $('#recommend-btn').click(function(){
          if(current_file == "")
            humane.error("Choose a file firstly!")
          else{
            humane.log("The file is being analyzed. Wait a second!");
            assertion_recommendation();
          }
        });

      });
    </script>
  </body>
</html>
